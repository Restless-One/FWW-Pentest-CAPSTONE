from flask import jsonify, request
from database.database import get_all_scans, get_all_vulnerabilities, Scan, Vulnerability
from db_test.db_test import DatabaseTest
from . import route_bp

# main page
@route_bp.route('/')
def index():
    return "Welcome to the Dashboard"

# scan page
@route_bp.route('/scan', methods=['GET'])
def get_scans():
    scans = Scan.query.all()
    result = []
    for scan in scans:
        result.append({
            'id': scan.id,
            'timestamp': scan.timestamp,
            'target_ip': scan.target_ip,
            'result_summary': scan.result_summary,
            'status': scan.status
        })
    return jsonify(result), 200

# vulnerability page
@route_bp.route('/vulnerabilities', methods=['GET'])
def get_vulnerabilities():
    vulnerabilities = get_all_vulnerabilities()
    result = []
    for vuln in vulnerabilities:
        result.append({
            'id': vuln.id,
            'scan_id': vuln.scan_id,
            'description': vuln.description,
            'severity': vuln.severity,
            'mitigation': vuln.mitigation
        })
    return jsonify(result), 200

# scan test page
@route_bp.route('/test_add_scan', methods=['POST'])
def test_add_scan():
    data = request.get_json()
    result, status_code = DatabaseTest.test_add_scan(data)
    return jsonify(result), status_code

# vulnerability test page
@route_bp.route('/test_add_vulnerability', methods=['POST'])
def test_add_vulnerability():
    data = request.get_json()
    result, status_code = DatabaseTest.test_add_vulnerability(data)
    return jsonify(result), status_code